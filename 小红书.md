# 综述

## 转化流程

$$曝光\text{ impression: }推荐系统让你看到了这篇笔记$$
$$\downarrow$$
$$点击\text{ click }（停留了几秒：有效点击）$$
$$\downarrow$$
$$滑动到底\text{ scroll to end }/点赞\text{ like }/收藏\text{ collect, save }/转发\text{ forward, share }/评论\text{ comment }$$

## 消费指标

这里说的都是对于某一篇笔记来说

点击率 CTR = $\frac{\text{点击次数}}{\text{曝光次数}}$

点赞率 = $\frac{\text{点赞次数}}{\text{点击次数}}$

收藏率 = $\frac{\text{收藏次数}}{\text{点击次数}}$

转发率 = $\frac{\text{转发次数}}{\text{点击次数}}$

阅读完成率 = $\frac{\text{滑动到底次数} \times f(\text{笔记长度})}{点击次数}$, f() 这里做的是归一化的事情，使得长笔记的完成率有补偿

只关注这些短期指标会竭泽而渔，长期来看要增加用户粘性和活跃度需要多样性

## 北极星指标

- 用户规模：日活用户数 DAU，月活用户数 MAU
- 消费：人均使用的时长，阅读笔记的数量
- 发布：渗透率，人均发布量

## 实验流程

$$离线实验：收集历史数据，在上面做训练和测试（回测），没有用户的交互$$
$$\downarrow$$
$$小流量\text{AB测试}：线上实验得到北极星指标$$
$$\downarrow$$
$$全流量上线（推全）$$

## 链路

$$\downarrow 亿$$
$$召回（有几十条通道，每条通道会取回几十～几百篇笔记）$$
$$\downarrow 千$$
$$粗排（轻量级的模型来打分，按排序来截断，保留分数最高的几百篇）$$
$$\downarrow 百$$
$$精排（大型神经网络，使用更多特征，计算量更大，小红书不做截断）$$
$$\downarrow 百$$
$$重排（按多样性抽样，相似内容打散，插入广告/运营内容）$$
$$\downarrow 十$$

## 召回通道

通道一般是常见的：协同过滤，双塔模型，关注的作者

之后会做去重和过滤（去掉用户不喜欢的话题/内容/作者）

## 粗排/精排

粗排使用规则保证筛选到的笔记具有多样性

$$用户特征 + 物品特征 + 统计特征$$
$$\downarrow$$
$$神经网络$$
$$\downarrow$$
$$预估值：点击率，点赞率，收藏率，转发率$$
$$比如 \downarrow 加权求和$$
$$排序分数$$

这里只是一个模型的结果，实践中需要再融合多个类似模型的分数

## 重拍

- 多样性抽样，比如说 MMR 或者 DPP，从几百篇选出几十篇
- 用规则打散笔记：比如说第一个内容是 NBA，那么附近就不能有 NBA 的内容
- 插入广告，运营推广内容，根据生态要求调整排序（不能连着出美女内容）
- 有最多的代码：好几千行，业务代码

# 实验和上线

## A/B 测试

1. 新的 GNN 召回通道的离线实验结果很好
2. 线上小流量 A/B 测试（10%），考察线上指标，选择最优的超参数（比如说 GNN 的深度取值 $\in \{1, 2, 3\}$）

## 随机分桶

按10%用户而不是流量10%

hash user id 成某个区间的整数，然后把这些整数均匀随机分成 10 个桶

我们可以让 1 号桶对应一个超参数，2号桶对应另一个，3号桶做对照组

计算每个桶的业务指标，比如说 DAU，人均使用时长，CTR 等等，如果显著优于对照组，那么说明策略有效，值得推全

## 分层实验

层：召回，粗排，精排，重拍，用户界面，广告

同一层互斥：
- 比如说 GNN 用了其中4个桶，那么其他实验只能用剩余的6个桶
- 策略可能是天然互斥的，用户只能使用其中一种
- 两条不同的召回通道可能会有相互增强/抵消的影响

不同层正交：
- 每一层独立随机对用户做分桶，每一层都可以使用100%的用户来做实验（有参考文献 Overlapping experiment infrastructure: more, better, faster experimentation：https://dl.acm.org/doi/abs/10.1145/1835804.1835810）
- 假设：不同层的实验之间通常不容易相互增强或抵消

## Holdout 机制

如何考察个人和部门对于业务指标的提升？

- 取出 10% 的用户作为 holdout 桶，推荐系统只使用剩余的 90% 用户做实验，两者互斥（用户界面可以仍可以使用 100% 用户做实验，因为是正交的）
- 最后计算 10% holdout 和 90% 实验桶的差别（需要归一化），就是整个推荐部门的业务指标收益
- 考核周期结束的时候清楚 holdout 桶，推全所有 100% 用户。然后重新随机划分 holdout 桶

## 推全

新建一个推全层（90%用户），这个层与其他层正交。新的召回实验会使用这一层作为 baseline吗？应该是的

## 反转实验

- 在新的推全层上，保留一个小反转桶使用旧的策略，长期观测新旧策略的区别
- 这个反转桶不会受到考核结束推全 100% 用户的影响，会长期保留
- 点击，交互会很快受到新策略的影响，但是长期留存指标有滞后性
- 有显著受益应当尽快推全，腾出桶提供给其他实验
- 反转实验是解决这个长短期的矛盾

# 召回算法

## ItemCF 基于物品的协同过滤

$$
推荐鹿鼎记 \leftarrow
\begin{cases}
1. 我喜欢看《笑傲江湖》\\
2. 《笑傲江湖》和《鹿鼎记》相似\\
3. 我没看过《鹿鼎记》
\end{cases}
$$

1 和 3 可以通过历史记录得知，算法解决的是 2

- 知识图谱：作者相同所以相似
- 用户行为：看过《笑傲江湖》的人也看过《鹿鼎记》，好评《笑傲江湖》的人也好评《鹿鼎记》

$$
用户 u
- 兴趣 \text{ like}(u, i_j) \rightarrow
\left\{
\begin{aligned}
物品 i_1 \\
物品 i_2 \\
物品 i_3
\end{aligned}
\right\}
\leftarrow
相似度 \text{ sim}(i_j, i)
\rightarrow
候选物品 i
$$

- 用户对交互过的物品兴趣的分数：根据互动的多少来打分 (fixed rules)
- 预估用户对候选物品的兴趣：$\displaystyle \sum_{j}\text{like(user, }item_j\text{)} \times \text{sim(}item_j\text{, item)}$

### 物品相似度

两个物品的受众重合度越高，两个物品就越相似

喜欢物品 $i_1$ 的用户记作集合 $W_1$，喜欢物品 $i_2$ 的用户记作集合 $W_2$

$$\text{sim(}i_1, i_2\text{)} = \frac{|W_1 \cap W_2|}{\sqrt{|W_1||W_2|}} \in (0, 1)$$

这个公式不涉及用户喜欢的程度，是 binary，下面这个余弦相似度公式使用了 like()：把每一个物品表示成一个稀疏向量，向量每一个元素对应一个用户，相似度就是两个向量夹角的余弦

$$\text{sim(}i_1, i_2\text{)} = \frac{\displaystyle\sum_{v \in W_1 \cap W_2}like(v, i_1) like(v, i_2)}{\sqrt{\displaystyle\sum_{u_1 \in W_1}like(u_1, i_1)^2} \sqrt{\displaystyle\sum_{u_2 \in W_2}like(u_2, i_2)^2}} \in (0, 1)$$

### 离线计算

为了能够及时 serve，需要事先做离线计算

用户 $\rightarrow$ 物品的索引：
- 每个用户的最近点击交互过的物品 id（比如说200个）以及分数
- user 2: [(item 3, 5), (item 7, 2), ...]

物品 $\rightarrow$ 物品的索引：
- 给定任意物品 id，可以快速找到最相似的 k 个物品以及相似度分数
- item 7: [(item 1, 0.7), (item 2, 0.6), ...]

为什么用索引？
- 离线计算量大，线上计算量小（避免枚举所有物品）
- 打分只需要给最多 nk 个物品打（比如说 100 * 20）

### 线上召回

1. 给定用户 id，通过用户 $\rightarrow$ 物品索引找到 last-n
2. 给 last-n 里每个物品通过物品 $\rightarrow$ 物品索引找到 top-k
3. 对这最多 nk 个物品计算预估的用户兴趣分数，截取前100个

## Swing 召回

解决 itemCF 的一个问题：如果重合的人是一个小圈子，比如说这两篇笔记被分享到微信群里了，那么 itemCF 计算出来的重合度高就不对了，其实这两篇笔记没什么相似的地方

itemCF 成立的前提是重合的人需要是大量的、不相关的人

定义两个用户的重合度：$\text{overlap}(u_1, u_2) = |J_1 \cap J_2|$, $J_i$ 是用户 $u_i$ 喜欢的物品集合

### 物品相似度

swing 模型计算相似度：$\text{sim(}i_1, i_2\text{)} = \displaystyle\sum_{u_1\in W_1 \cap W_2}\displaystyle\sum_{u_2\in W_1 \cap W_2}\frac{1}{\alpha + \text{overlap}(u_1, u_2)}$, 集合 $W_j$ 是喜欢物品 $i_j$ 的人的集合

$\alpha$ 是一个可以调节的超参数，如果某两个人 $u_1, u_2$ 同时喜欢物品 $i_1, i_2$，但是他们两个的重合度很高，那么分母变大，权重降低

## UserCF

$$
推荐这篇笔记 \leftarrow
\begin{cases}
1. 有很多网友和我兴趣非常相似\\
2. 其中一个网友对某一篇笔记点赞、转发\\
3. 我没看过这篇笔记
\end{cases}
$$

如何找到兴趣非常相似的网友呢？
- 交互的笔记有很大的重合
- 关注的作者有很大的重合

$$
用户 u
\leftarrow 相似度 \text{ sim}(u, u_j) \rightarrow
\left\{
\begin{aligned}
用户 u_1 \\
用户 u_2 \\
用户 u_3
\end{aligned}
\right\}
- 兴趣 \text{ like}(u_j, i)
\rightarrow
候选物品 i
$$

预估用户对预选物品的兴趣：$\displaystyle \sum_{j}\text{sim}(u, u_j) \times \text{like}(u_j, i)$

### 用户相似度

用户相似度：$\text{sim}(u_1, u_2) = \frac{|J_1 \cap J_2|}{\sqrt{|J_1||J_2|}} = \frac{\displaystyle\sum_{l \in |J_1 \cap J_2|}1}{\sqrt{|J_1||J_2|}} \in (0, 1)$, $J_i$ 是用户 $u_i$ 喜欢的物品集合

把用户表示为一个稀疏向量，每个元素对应一个物品，相似度sim()就是两个向量夹角的余弦

越热门的物品，对计算相似度就越没有用，重合的东西越冷门越能反映两个人的兴趣真的很相似，改写用户类似度为：$\text{sim}(u_1, u_2) = \frac{\displaystyle\sum_{l \in |J_1 \cap J_2|}\frac{1}{log(1 + n_l)}}{\sqrt{|J_1||J_2|}} \in (0, 1)$, $n_l$ 是喜欢物品l的用户数量，反映了物品的热门程度

### 离线计算

- 需要一个和 itemCF 相同的用户 $\rightarrow$ 物品的索引
- 需要一个用户 $\rightarrow$ 用户的索引
- user 7: [(user 1, 0.7), (user 2, 0.6), ...]

### 线上召回

1. 给定用户 id，通过用户 $\rightarrow$ 用户索引找到 top-k
2. 给 top-k 里每个用户通过用户 $\rightarrow$ 物品索引找到 last-n
3. 对这最多 nk 个物品计算预估的用户兴趣分数，截取前100个